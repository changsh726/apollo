<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>How to add a new Lidar driver - Apollo Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Apollo Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../quick_start.md" class="nav-link">Get Started</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Cyber RT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../cyber/" class="dropdown-item">Introduction to Cyber RT</a>
</li>
                                    
<li>
    <a href="../../cyber/cyber_rt_quick_start.md" class="dropdown-item">Cyber RT Quick Start</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../FAQs/" class="nav-link">FAQs</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/ApolloAuto/apollo/edit/master/docs/howto/how_to_add_a_new_lidar_driver.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#how-to-add-a-new-lidar-driver" class="nav-link">How to add a new Lidar driver</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#introduction" class="nav-link">Introduction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#whats-inside-a-lidar-driver" class="nav-link">What's inside a lidar driver</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#steps-to-add-a-new-lidar-driver" class="nav-link">Steps to add a new Lidar driver</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="how-to-add-a-new-lidar-driver">How to add a new Lidar driver</h1>
<h2 id="introduction">Introduction</h2>
<p>Lidar is a commonly used environment-aware sensor. Lidar uses pulsed laser to illuminate a target, receives the reflected pulse from the target, then calculates the distance to the target based on the time of laser return. Differences in multiple measurements can then be used to make digital 3-D representations of the environment.</p>
<p>As default, Apollo platform support multiple types of Lidar drivers, including 16 channels, 32 channels, 64 channels and 128 channels Velodyne lidars. This manual describes the major functions of Lidar driver and how to add a new lidar driver in Apollo platform.</p>
<h2 id="whats-inside-a-lidar-driver">What's inside a lidar driver</h2>
<p>Taking velodyne lidar driver as an example, there are three major components:</p>
<ol>
<li><a href="https://github.com/ApolloAuto/apollo/tree/master/modules/drivers/velodyne/driver">Driver</a>: Driver receives UDP data packets from lidar sensor, and packages the data packets into a frame of scanning data in the format of VelodyneScan. VelodyneScan is defined in file below:</li>
</ol>
<pre><code>modules/drivers/velodyne/proto/velodyne.proto
</code></pre>

<ol>
<li><a href="https://github.com/ApolloAuto/apollo/tree/master/modules/drivers/velodyne/parser">Parser</a>: Parser takes one frame data in format of VelodyneScan as input, converts the cloud points in the frame from spherical coordinate system to Cartesian coordinates system, then sends out the point cloud as output. The pointcloud format is defined in file below:</li>
</ol>
<pre><code>modules/drivers/proto/pointcloud.proto
</code></pre>

<ol>
<li><a href="https://github.com/ApolloAuto/apollo/tree/master/modules/drivers/velodyne/compensator">Compensator</a>: Compensator takes pointcloud data and pose data as inputs. Based on the corresponding pose information for each cloud point, it converts each cloud point information aligned with the latest time in the current lidar scan frame, minimizing the motion error due the movement of the vehicle. Thus, each cloud point needs carry its own timestamp information.</li>
</ol>
<h2 id="steps-to-add-a-new-lidar-driver">Steps to add a new Lidar driver</h2>
<h4 id="1-get-familiar-with-apollo-cyber-rt-framework">1. Get familiar with Apollo Cyber RT framework.</h4>
<p>Please refer to the <a href="https://github.com/ApolloAuto/apollo/tree/master/docs/cyber">manuals of Apollo Cyber RT</a>.</p>
<h4 id="2-define-message-for-raw-data">2. Define message for raw data</h4>
<p>Apollo already define the format of pointcloud. For new lidar, you only need to define the protobuf message for the raw scannning data. Those raw data will be used for archive and offline development. Compared to processed pointcloud data, raw data saves a lot of storage spaces for long term. The new message of the scan data can be define as below:</p>
<pre><code class="c++">// a scan message sample
message ScanData {
    optional apollo.common.Header header = 1;  // apollo header
    optional Model model = 2;                  // device model
    optional Mode mode = 3;                    // work mode
    // device serial number, corresponds to a specific calibration file
    optional string sn = 4;
    repeated bytes raw_data = 5;               // raw scan data
}
</code></pre>

<p>In velodyne driver, the scan data message is define as <a href="https://github.com/ApolloAuto/apollo/blob/master/modules/drivers/velodyne/proto/velodyne.proto#L29">VelodyneScan</a>.</p>
<h4 id="3-access-the-raw-data">3. Access the raw data</h4>
<p>Each seconds, Lidar will generate a lot of data, so it relied on UDP to efficiently transport the raw data. You need to create a DriverComponent class, which inherits the Component withotu any parameter. In its Init function, you need to start a async polling thread, whic will receive Lidar data from the specific port. Then depending on the Lidar's frequency, the DriverComponent needs to package all the packets in a fix period into a frame of ScanData. Eventually, the writer will send the ScanData through a corresponding channel.</p>
<pre><code class="c++">// Inherit component with no template parameters, 
// do not receive message from any channel
class DriverComponent : public Component&lt;&gt; {
 public:
  ~VelodyneDriverComponent();
  bool Init() override {
    poll_thread_.reset(new thread([this]{
        this-&gt;Poll();
    }));
  }

 private: 
  void Poll() {
    while (apollo::cyber::Ok()) {
      // poll data from port xxx
      // ...
      austo scan = std::make_shared&lt;ScanData&gt;();
      // pack ScanData
      // ...
      writer_.write(scan);
    }
  }

  std::shared_ptr&lt;std::thread&gt; poll_thread_;
  std::shared_ptr&lt;apollo::cyber::Writer&lt;ScanData&gt;&gt; writer_;
};

CYBER_REGISTER_COMPONENT(DriverComponent)
</code></pre>

<h4 id="4-parse-the-scan-data-convert-to-pointcloud">4. Parse the scan data, convert to pointcloud</h4>
<p>If the new lidar driver already provides the pointcloud data in Cartesian coordinates system, then you just need to store those data in the protobuf format defined in Apollo.</p>
<p>The Parser converts the lidar raw data to the pointcloud format in Cartesian coordinates system. Parser takes ScanData as input. For each cloud point, it will parse the timestamp, x/y/z coordinates and intensity, then packages all the cloudpoint information into a frame of pointcloud. Each cloud point transformed into the FLU (Front: x, Left: y, Up: z）coordinates with Lidar as the origin point.</p>
<pre><code class="c++">message PointXYZIT {
  optional float x = 1 [default = nan];
  optional float y = 2 [default = nan];
  optional float z = 3 [default = nan];
  optional uint32 intensity = 4 [default = 0];
  optional uint64 timestamp = 5 [default = 0];
}
</code></pre>

<p>Then you need to create a new ParserComponent，which inherits Components templates with ScanData. ParserComponent takes ScanData as input, then generates pointcloud message and sents it out.</p>
<pre><code class="c++">...
class ParserComponent : public Component&lt;ScanData&gt; {
 public:
  bool Init() override {
    ...
  }

  bool Proc(const std::shared_ptr&lt;ScanData&gt;&amp; scan_msg) override {
    // get a pointcloud object from objects pool
    auto point_cloud_out = point_cloud_pool_-&gt;GetObject(); 
    // clear befor using
    point_cloud_out-&gt;clear();   
    // parse scan data and generate pointcloud
    parser_-&gt;parse(scan_msg, point_cloud_out);
    // write pointcloud to a specific channel
    writer_-&gt;write(point_cloud);
  }

 private:
  std::shared_ptr&lt;Writer&lt;PointCloud&gt;&gt; writer_;
  std::unique_ptr&lt;Parser&gt; parser_ = nullptr;

  std::shared_ptr&lt;CCObjectPool&lt;PointCloud&gt;&gt; point_cloud_pool_ = nullptr; 
  int pool_size_ = 8;
};

CYBER_REGISTER_COMPONENT(ParserComponent)
</code></pre>

<h4 id="5-motion-compensation-for-pointcloud">5. Motion compensation for pointcloud</h4>
<p>Motion compensation is optional depends on lidar hardware design. E.g. if the the pointcloud information from lidar already have the motion error included, then no compensator needed as extra steps. Otherwise, you need your own compensator. However, if each cloud point in your lidar's output carries its own timestamp information, you can probably reuse the current compensator without any changes.</p>
<h4 id="6-configure-the-dag-file">6. Configure the dag file</h4>
<p>After done with each component, you just need to configure the DAG config file to add each component into the data processing pipeline. E.g.  lidar_driver.dag:</p>
<pre><code class="python"># Define all coms in DAG streaming.
module_config {
    module_library : &quot;/apollo/bazel-bin/modules/drivers/xxx/driver/libxxx_driver_component.so&quot;
    components {
      class_name : &quot;DriverComponent&quot;
      config {
        name : &quot;xxx_driver&quot;
        config_file_path : &quot;/path/to/lidar_driver_conf.pb.txt&quot;
      }
    }
}

module_config {
    module_library : &quot;/apollo/bazel-bin/modules/drivers/xxx/parser/libxxx_parser_component.so&quot;
    components {
      class_name : &quot;ParserComponent&quot;
      config {
        name : &quot;xxx_parser&quot;
        config_file_path : &quot;/path/to/lidar_parser_conf.pb.txt&quot;
        readers { channel: &quot;/apollo/sensor/xxx/Scan&quot; }
      }
    }
}

module_config {
    module_library : &quot;/apollo/bazel-bin/modules/drivers/xxx/compensator/libxxx_compensator_component.so&quot;
    components {
      class_name : &quot;CompensatorComponent&quot;
      config {
        name : &quot;pointcloud_compensator&quot;
        config_file_path : &quot;/apollo/modules/drivers/xxx/conf/xxx_compensator_conf.pb.txt&quot;
        readers {channel: &quot;/apollo/sensor/xxx/PointCloud2&quot;}
      }
    }
}
</code></pre>

<h4 id="7-run-the-lidar-driver-and-visualize-the-pointlcoud-output">7. Run the lidar driver and visualize the pointlcoud output</h4>
<p>After finishing all the previous steps, you can use the following command to start your new lidar driver.</p>
<pre><code class="bash">mainboard -d /path/to/lidar_driver.dag
</code></pre>

<p>To visualize the pointcloud output, you can run <code>cyber_visualizer</code> and choose the right channel for the pointcloud.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
