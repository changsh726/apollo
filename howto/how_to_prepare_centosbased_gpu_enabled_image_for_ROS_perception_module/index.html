<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>how to prepare centosbased gpu enabled image for ROS perception module - Apollo Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Apollo Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../quick_start.md" class="nav-link">Get Started</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Cyber RT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../cyber/" class="dropdown-item">Introduction to Cyber RT</a>
</li>
                                    
<li>
    <a href="../../cyber/cyber_rt_quick_start.md" class="dropdown-item">Cyber RT Quick Start</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../FAQs/" class="nav-link">FAQs</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/ApolloAuto/apollo/edit/master/docs/howto/how_to_prepare_centosbased_gpu_enabled_image_for_ROS_perception_module.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#how-to-prepare-centos7-based-gpu-enabled-image-for-the-perception-module" class="nav-link">How to Prepare CENTOS(7) based GPU enabled image for the Perception Module</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#setup-docker-image-in-centos-based-system" class="nav-link">Setup docker image in CentOS based system</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#gpu-enabled-container-for-perception-research" class="nav-link">GPU enabled container for perception research</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#prebuild-image-for-download" class="nav-link">Prebuild image for download</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#troubleshooting" class="nav-link">Troubleshooting</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#contact-me" class="nav-link">Contact me</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="how-to-prepare-centos7-based-gpu-enabled-image-for-the-perception-module">How to Prepare CENTOS(7) based GPU enabled image for the Perception Module</h2>
<h2 id="setup-docker-image-in-centos-based-system">Setup docker image in CentOS based system</h2>
<p>ApolloAuto uses Ubuntu partially because of the Linux distribution dependency of ROS indigo. There is a script
<code>${apollo\_root}/docker/scripts/install\_dcoker.sh</code> inside the docker image involved. Most cloud based servers have already installed docker, hence you can just go ahead without touching it.</p>
<p>In CentOS, to install docker
you can either follow <a href="https://docs.docker.com/engine/installation/linux/docker-ce/centos/#os-requirements">this installation guide</a>
 to install Docker- CE for CentOS or you could write the following:</p>
<blockquote>
<p>sudo yum update &amp;&amp; sudo yum install -y docker</p>
</blockquote>
<p>Start docker by</p>
<blockquote>
<p>sudo systemctl start docker</p>
</blockquote>
<p>Check its health status by</p>
<blockquote>
<p>sudo systemctl status docker</p>
</blockquote>
<p>As a matter of the fact, we recommend you to install <code>nvidia-docker</code>. <code>Nvidia-docker2</code> is currently
under <code>alpha</code> verision, and should not be used in production environment.</p>
<p>As typically sugggested by Docker, you should add your name to the docker group</p>
<blockquote>
<p>sudo usermod -aG docker $(whoami)</p>
</blockquote>
<p>You can then build out Apollo based on the steps in the installation guide.</p>
<p>Before executing <code>dev_start.sh</code> to build or pull an image from  apolloauto for CentOS, you have to
modify ${apollo_auto}/scripts/docker_adduser.sh first by adding <code>--force-badname</code> in line 21.</p>
<blockquote>
<p>adduser --force-badname --disable-password ...</p>
</blockquote>
<h2 id="gpu-enabled-container-for-perception-research">GPU enabled container for perception research</h2>
<h4 id="update-driver-in-host">Update driver in host</h4>
<p>This part is much more tricky because you have to install an nvidia driver in docker container as the same
version of that in your host machine and stop "nvidia.uvm" relevant modules.</p>
<p>If you are using <code>VirtualBox</code>, whether the virtual graphic adapter (VGA) can pass through hardware depends
on your nvidia driver and gpu versions. Some developlers suggest KVM, VMWare and Xen where hardware passthrough to VM
is well developed.</p>
<p>Check hardware modules from nvidia driver, using</p>
<pre><code>&gt; lsmod | grep nvidia
</code></pre>
<p>To successfully build nvidia driver <code>375.39</code> suggested by Baidu, you have to download the compatible linux source version, for example
<code>3.10.0-693.5.2.el7.x86_64</code> and pass it to the "NVIDIA.*run". Whether it
will or not succeed really depends on your Linux Kernel version. Please vim "NVIDIA.*run" to check correct keyword to pass.</p>
<h4 id="update-driver-in-docker">Update driver in docker</h4>
<p>Although you can succeed in the above solution, it is not recommended as it is time intensive and not very efficient.</p>
<p>A better way is to apply for operation time and update Baidu's driver inside docker. The following problems may arise:</p>
<ol>
<li>gcc version confliction with NVIDIA driver:</li>
<li>baidu uses gcc-4.8.4, it is old, check <code>install_nvidia_driver.sh</code> to see how to update</li>
<li>bazel dependency: after installation of the driver, you would have to roll back the default gcc version to build apollo</li>
<li>resintall cuda: it will cost you roughly 2GB, please scale the container to proper size by adjusting paremters in <code>docker run</code> statement</li>
<li>inspect mounted disk inside docker, <code>df -h</code>, replace the directory which you think good in <code>reinstall_cuda.sh</code>
     keyword <code>--tmpdir</code></li>
</ol>
<p>After installation you, can check the situation by issuing</p>
<pre><code class="bash">cat /proc/driver/nvidia/version
nvidia-smi
</code></pre>

<p><code>nvidia-smi</code> should work normally now.</p>
<p>Finally,</p>
<pre><code>&gt; ./apollo.sh build_gpu &amp;&amp; ./scripts/percetion.sh start
</code></pre>
<p>If there is no error records in <code>data/log/</code>, you are good to go.</p>
<h2 id="prebuild-image-for-download">Prebuild image for download</h2>
<p>You can refer to my <a href="https://hub.docker.com/r/yiakwy/apolloautocentos_gpu">DockerHub</a> for further instructions.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>What if you committed incorrect <code>\*.pd.txt</code> files and cannot rebase to the latest developer branch? Try the
following commands:</p>
<pre><code>git reset --soft HEAD^ # back to the staging area from previous commit
for f in $UNWANTED_FILES
    git reset HEAD $f
    git git update-index --assume-unchanged $f
git commit -m ${MESSAGE}
</code></pre>

<p>replace it with the arguments you actually need.</p>
<h2 id="contact-me">Contact me</h2>
<p>https://yiakwy.github.io</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
