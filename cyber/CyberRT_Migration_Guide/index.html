<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Migration guide from Apollo ROS - Apollo Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Apollo Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../quick_start.md" class="nav-link">Get Started</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Cyber RT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Introduction to Cyber RT</a>
</li>
                                    
<li>
    <a href="../cyber_rt_quick_start.md" class="dropdown-item">Cyber RT Quick Start</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../FAQs/" class="nav-link">FAQs</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/ApolloAuto/apollo/edit/master/docs/cyber/CyberRT_Migration_Guide.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#migration-guide-from-apollo-ros" class="nav-link">Migration guide from Apollo ROS</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#build-system" class="nav-link">Build system</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#folder-structure" class="nav-link">Folder structure</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#update-source-code" class="nav-link">Update source code</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#tools-mapping" class="nav-link">Tools mapping</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ros-bag-data-migration" class="nav-link">ROS bag data migration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="migration-guide-from-apollo-ros">Migration guide from Apollo ROS</h1>
<p>This article describes the essential changes for projects to migrate from Apollo ROS (Apollo 3.0 and before) to Apollo Cyber RT (Apollo 3.5 and after). We will be using the very first ROS project talker/listener as example to demonstrate step by step migration instruction.</p>
<h2 id="build-system">Build system</h2>
<p>ROS use <code>CMake</code> as its build system but Cyber RT use <code>bazel</code>. In a ROS project, CmakeLists.txt and package.xml are required for defining build configs like build target, dependency, message files and so on. As for a Cyber RT component, a single bazel BUILD file covers. Some key build config mappings are listed below.</p>
<p>Cmake</p>
<pre><code class="cmake">project(pb_msgs_example)
add_proto_files(
  DIRECTORY proto
  FILES chatter.proto
)
## Declare a C++ executable
add_executable(pb_talker src/talker.cpp)
target_link_libraries(pb_talker ${catkin_LIBRARIES}pb_msgs_example_proto)
add_executable(pb_listener src/listener.cpp)
target_link_libraries(pb_listener ${catkin_LIBRARIES}  pb_msgs_example_proto)
</code></pre>

<p>Bazel</p>
<pre><code class="python">cc_binary(
  name = &quot;talker&quot;,
  srcs = [&quot;talker.cc&quot;],
  deps = [
    &quot;//cyber&quot;,
    &quot;//cyber/examples/proto:examples_cc_proto&quot;,
    ],
  )
cc_binary(
  name = &quot;listener&quot;,
  srcs = [&quot;listener.cc&quot;],
  deps = [
    &quot;//cyber&quot;,
    &quot;//cyber/examples/proto:examples_cc_proto&quot;,
    ],
  )
</code></pre>

<p>We can find the mapping easily from the 2 file snippets. For example, <code>pb_talker</code> and <code>src/talker.cpp</code> in cmake <code>add_executable</code> setting map to <code>name = "talker"</code> and <code>srcs = ["talker.cc"]</code> in BUILD file <code>cc_binary</code>.</p>
<h3 id="proto">Proto</h3>
<p>Apollo ROS has customized to support proto message formate that a separate section <code>add_proto_files</code> and projectName_proto(<code>pb_msgs_example_proto</code>) in <code>target_link_libraries</code> are required to send message in proto formate. For config proto message in Cyber RT, it's as simple as adding the target proto file path concantenated with name of <code>cc_proto_library</code> in <code>deps</code> setting. The <code>cc_proto_library</code> is set up in BUILD file under proto folder.</p>
<pre><code class="python">cc_proto_library(
  name = &quot;examples_cc_proto&quot;,
  deps = [
    &quot;:examples_proto&quot;,
  ],
)
proto_library(
  name = &quot;examples_proto&quot;,
  srcs = [
    &quot;examples.proto&quot;,
  ],
)
</code></pre>

<p>The package definition has also changed in Cyber RT. In Apollo ROS a fixed package <code>package pb_msgs;</code> is used for proto files, but in Cyber RT, the proto file path <code>package apollo.cyber.examples.proto;</code> is used instead.</p>
<h2 id="folder-structure">Folder structure</h2>
<p>As shown below, Cyber RT remove the src folder and pull all source code in the same folder as BUILD file. BUILD file plays the same role as CMakeLists.txt plus package.xml. Both Cyber RT and Apollo ROS talker/listener example have a proto folder for message proto files but Cyber RT requires a separate BUILD file for proto folder to set up the proto library.</p>
<h3 id="apollo-ros">Apollo ROS</h3>
<ul>
<li>CMakeLists.txt</li>
<li>package.xml</li>
<li>proto</li>
<li>chatter.proto</li>
<li>src</li>
<li>listener.cpp</li>
<li>talker.cpp</li>
</ul>
<h3 id="cyber-rt">Cyber RT</h3>
<ul>
<li>BUILD</li>
<li>listener.cc</li>
<li>talker.cc</li>
<li>proto</li>
<li>BUILD</li>
<li>examples.proto (with chatter message)</li>
</ul>
<h2 id="update-source-code">Update source code</h2>
<h3 id="listener">Listener</h3>
<p>Cyber RT</p>
<pre><code class="cpp">#include &quot;cyber/cyber.h&quot;
#include &quot;cyber/examples/proto/examples.pb.h&quot;

void MessageCallback(
    const std::shared_ptr&lt;apollo::cyber::examples::proto::Chatter&gt;&amp; msg) {
  AINFO &lt;&lt; &quot;Received message seq-&gt; &quot; &lt;&lt; msg-&gt;seq();
  AINFO &lt;&lt; &quot;msgcontent-&gt;&quot; &lt;&lt; msg-&gt;content();
}

int main(int argc, char* argv[]) {
  // init cyber framework
  apollo::cyber::Init(argv[0]);
  // create listener node
  auto listener_node = apollo::cyber::CreateNode(&quot;listener&quot;);
  // create listener
  auto listener =
      listener_node-&gt;CreateReader&lt;apollo::cyber::examples::proto::Chatter&gt;(
          &quot;channel/chatter&quot;, MessageCallback);
  apollo::cyber::WaitForShutdown();
  return 0;
}
</code></pre>

<p>ROS</p>
<pre><code class="cpp">#include &quot;ros/ros.h&quot;
#include &quot;chatter.pb.h&quot;

void MessageCallback(const boost::shared_ptr&lt;pb_msgs::Chatter&gt;&amp; msg) {
  ROS_INFO_STREAM(&quot;Time: &quot; &lt;&lt; msg-&gt;stamp().sec() &lt;&lt; &quot;.&quot; &lt;&lt; msg-&gt;stamp().nsec());
  ROS_INFO(&quot;I heard pb Chatter message: [%s]&quot;, msg-&gt;content().c_str());
}

int main(int argc, char** argv) {
  ros::init(argc, argv, &quot;listener&quot;);
  ros::NodeHandle n;
  ros::Subscriber pb_sub = n.subscribe(&quot;chatter&quot;, 1000, MessageCallback);
  ros::spin();
  return 0;
}
</code></pre>

<p>You can see easily from the two listener code above that Cyber RT provides very similar API to for developers to migrate from ROS.</p>
<ul>
<li><code>ros::init(argc, argv, "listener");</code> --&gt; <code>apollo::cyber::Init(argv[0]);</code></li>
<li><code>ros::NodeHandle n;</code> --&gt; <code>auto listener_node = apollo::cyber::CreateNode("listener");</code></li>
<li><code>ros::Subscriber pb_sub = n.subscribe("chatter", 1000, MessageCallback);</code> --&gt; <code>auto listener =
      listener_node-&gt;CreateReader("channel/chatter", MessageCallback);</code></li>
<li><code>ros::spin();</code> --&gt; <code>apollo::cyber::WaitForShutdown();</code></li>
</ul>
<p>Note: for Cyber RT, a listener node has to use <code>node-&gt;CreateReader&lt;messageType&gt;(channelName, callback)</code> to read data from channel.</p>
<h3 id="talker">Talker</h3>
<p>Cyber RT</p>
<pre><code class="cpp">#include &quot;cyber/cyber.h&quot;
#include &quot;cyber/examples/proto/examples.pb.h&quot;

using apollo::cyber::examples::proto::Chatter;

int main(int argc, char *argv[]) {
  // init cyber framework
  apollo::cyber::Init(argv[0]);
  // create talker node
  auto talker_node = apollo::cyber::CreateNode(&quot;talker&quot;);
  // create talker
  auto talker = talker_node-&gt;CreateWriter&lt;Chatter&gt;(&quot;channel/chatter&quot;);
  Rate rate(1.0);
  while (apollo::cyber::OK()) {
    static uint64_t seq = 0;
    auto msg = std::make_shared&lt;Chatter&gt;();
    msg-&gt;set_timestamp(Time::Now().ToNanosecond());
    msg-&gt;set_lidar_timestamp(Time::Now().ToNanosecond());
    msg-&gt;set_seq(seq++);
    msg-&gt;set_content(&quot;Hello, apollo!&quot;);
    talker-&gt;Write(msg);
    AINFO &lt;&lt; &quot;talker sent a message!&quot;;
    rate.Sleep();
  }
  return 0;
}
</code></pre>

<p>ROS</p>
<pre><code class="cpp">#include &quot;ros/ros.h&quot;
#include &quot;chatter.pb.h&quot;

#include &lt;sstream&gt;

int main(int argc, char** argv) {
  ros::init(argc, argv, &quot;talker&quot;);
  ros::NodeHandle n;
  ros::Publisher chatter_pub = n.advertise&lt;pb_msgs::Chatter&gt;(&quot;chatter&quot;, 1000);
  ros::Rate loop_rate(10);
  int count = 0;
  while (ros::ok()) {
    pb_msgs::Chatter msg;
    ros::Time now = ros::Time::now();
    msg.mutable_stamp()-&gt;set_sec(now.sec);
    msg.mutable_stamp()-&gt;set_nsec(now.nsec);
    std::stringstream ss;
    ss &lt;&lt; &quot;Hello world &quot; &lt;&lt; count;
    msg.set_content(ss.str());
    chatter_pub.publish(msg);
    ros::spinOnce();
    loop_rate.sleep();
  }
  return 0;
}
</code></pre>

<p>Most of the mappings are illustrated in listener code above, the rest are listed here.</p>
<ul>
<li>
<p><code>ros::Publisher chatter_pub = n.advertise&lt;pb_msgs::Chatter&gt;("chatter", 1000);</code> --&gt; <code>auto talker = talker_node-&gt;CreateWriter&lt;Chatter&gt;("channel/chatter");</code></p>
</li>
<li>
<p><code>chatter_pub.publish(msg);</code> --&gt; <code>talker-&gt;Write(msg);</code></p>
</li>
</ul>
<h2 id="tools-mapping">Tools mapping</h2>
<table>
<thead>
<tr>
<th align="left">ROS</th>
<th align="left">Cyber RT</th>
<th align="left">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">rosbag</td>
<td align="left">cyber_recorder</td>
<td align="left">data file</td>
</tr>
<tr>
<td align="left">scripts/diagnostics.sh</td>
<td align="left">cyber_monitor</td>
<td align="left">channel debug</td>
</tr>
<tr>
<td align="left">offline_lidar_visualizer_tool</td>
<td align="left">cyber_visualizer</td>
<td align="left">point cloud visualizer</td>
</tr>
</tbody>
</table>
<h2 id="ros-bag-data-migration">ROS bag data migration</h2>
<p>The data file changed from ROS bag to Cyber record in Cyber RT. Cyber RT has a data migration tool <code>rosbag_to_record</code> for users to easily migrate data files before Apollo 3.0 (ROS) to Cyber RT like the sample usage below.</p>
<pre><code class="bash">rosbag_to_record demo_3.0.bag demo_3.5.record
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
