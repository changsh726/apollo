<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Multiple-LiDAR GNSS Calibration Guide - Apollo Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Apollo Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../quick_start.md" class="nav-link">Get Started</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Cyber RT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../cyber/" class="dropdown-item">Introduction to Cyber RT</a>
</li>
                                    
<li>
    <a href="../../cyber/cyber_rt_quick_start.md" class="dropdown-item">Cyber RT Quick Start</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../FAQs/" class="nav-link">FAQs</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/ApolloAuto/apollo/edit/master/docs/quickstart/multiple_lidar_gnss_calibration_guide.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#multiple-lidar-gnss-calibration-guide" class="nav-link">Multiple-LiDAR GNSS Calibration Guide</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#contents" class="nav-link">Contents</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#preparation" class="nav-link">Preparation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#using-the-calibration-tool" class="nav-link">Using the Calibration Tool</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#results-and-validation" class="nav-link">Results and Validation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="multiple-lidar-gnss-calibration-guide">Multiple-LiDAR GNSS Calibration Guide</h1>
<pre><code>NOTE: Supports upto Apollo 3.0. Apollo 3.5 is not supported yet.
</code></pre>

<p>Welcome to use the Multiple-LiDAR GNSS calibration tool. This guide will show you the steps to successfully calibrate multiple LiDARs.</p>
<h2 id="contents">Contents</h2>
<ul>
<li>Overview</li>
<li>Preparation</li>
<li>Using the Calibration Tool</li>
<li>Results and Validation</li>
</ul>
<h2 id="overview">Overview</h2>
<p>In many autonomous driving tasks such as HDMap production, the scans from multiple LiDARs need to be registered in a unified coordinate system. In this case, the extrinsic parameters of multiple LiDARs need to be carefully calibrated. This Multiple-LiDAR GNSS calibration tool is developed to solve this problem.</p>
<h2 id="preparation">Preparation</h2>
<ol>
<li>Download the <a href="https://github.com/ApolloAuto/apollo/releases/download/v2.5.0/multi_lidar_gnss_calibrator_and_doc.zip">calibration tool</a>, and extract files to <code>$APOLLO_HOME/modules/calibration</code>. APOLLO_HOME is the root directory of apollo repository.</li>
<li>Choose a calibration place according to the calibration guide provided in Apollo 1.5.</li>
<li>Make sure the GNSS is in a good status. To verify this, use <code>rostopic echo /apollo/sensor/gnss/best_pose</code> and check the number after keywords <code>latitude_std_dev</code>, <code>longitude_std_dev</code> and <code>height_std_dev</code>. The smaller the deviation, the better the calibration quality. <strong><em> We strongly recommend calibrating the sensors when deviations are smaller than 0.02.</em></strong> </li>
</ol>
<h2 id="using-the-calibration-tool">Using the Calibration Tool</h2>
<h3 id="record-calibration-data">Record Calibration Data</h3>
<p>When the LiDARs and GNSS are ready, use <code>/apollo/modules/calibration/multi_lidar_gnss/record.sh</code> to record calibration data. Note that, this script is only for recording  velodyne HDL64 and VLP16. For other purpose, some modification of this script is needed or just use rosbag record to do the same thing. Usually, 2 minites length of data is sufficient. After data capture, run <code>/apollo/modules/calibration/multi_lidar_gnss/calibrate.sh</code> to calibrate sensors. The script is composed of the following two steps.</p>
<h3 id="export-data">Export Data</h3>
<p>Once the calibration bag is recorded, use <code>/apollo/modules/calibration/exporter/export_msgs --config /apollo/modules/calibration/exporter/conf/export_config.yaml</code> to get sensor data. The only input of the exporter is a YAML configuration file as follow.</p>
<pre><code class="bash">bag_path: &quot;/apollo/data/bag/calibration/&quot; # The path where the calibration bag is placed.
dump_dir: &quot;/apollo/data/bag/calibration/export/&quot; # The path where the sensor data will be placed using exporter
topics:
    - /apollo/sensor/gnss/odometry: # Odometry topic name
        type: ApolloOdometry        # Odometry type
    - /apollo/sensor/velodyne16/PointCloud2: # vlp16 topic name
        type: PointCloud2                    # vlp16 type
    - /apollo/sensor/velodyne64/PointCloud2: # hdl64 topic name
        type: PointCloud2                    # hdl64 type
</code></pre>

<p>Other topics of PointCloud2 type also can be exported, if new topics are added to the file in the rule as follow.</p>
<pre><code class="bash">    - TOPIC_NAME: # topic name
        type: PointCloud2
</code></pre>

<p>Till now, we only support <code>ApolloOdometry</code> and <code>PointCloud2</code>.  </p>
<h3 id="run-the-calibration-tool">Run the Calibration Tool</h3>
<p>If all sensor data are exported, run <code>/apollo/modules/calibration/lidar_gnss_calibrator/multi_lidar_gnss_calibrator --config /apollo/modules/calibration/lidar_gnss_calibrator/conf/multi_lidar_gnss_calibrator_config.yaml</code> will get the results. The input of the tool is a YAML configuration file as follow.</p>
<pre><code class="bash"># multi-LiDAR-GNSS calibration configurations
data:
    odometry: &quot;/apollo/data/bag/calibration/export/multi_lidar_gnss/_apollo_sensor_gnss_odometry/odometry&quot;
    lidars: 
        - velodyne16: 
            path: &quot;/apollo/data/bag/calibration/export/multi_lidar_gnss/_apollo_sensor_velodyne16_PointCloud2/&quot;
        - velodyne64: 
            path: &quot;/apollo/data/bag/calibration/export/multi_lidar_gnss/_apollo_sensor_velodyne64_PointCloud2/&quot;
    result: &quot;/apollo/data/bag/calibration/export/multi_lidar_gnss/result/&quot;
calibration:
    init_extrinsics:
        velodyne16:
            translation:    
                x: 0.0
                y: 1.77 
                z: 1.1
            rotation:
                x: 0.183014 
                y: -0.183014 
                z: 0.683008 
                w: 0.683008
        velodyne64:
            translation:    
                x: 0.0
                y: 1.57
                z: 1.3
            rotation:
                x: 0.0
                y: 0.0
                z: 0.707
                w: 0.707
    steps: 
        - source_lidars: [&quot;velodyne64&quot;]
          target_lidars: [&quot;velodyne64&quot;]
          lidar_type: &quot;multiple&quot;
          fix_target_lidars: false
          fix_z: true
          iteration: 3
        - source_lidars: [&quot;velodyne16&quot;]
          target_lidars: [&quot;velodyne16&quot;]
          lidar_type: &quot;multiple&quot;
          fix_target_lidars: false
          fix_z: true
          iteration: 3
        - source_lidars: [&quot;velodyne16&quot;]
          target_lidars: [&quot;velodyne64&quot;]
          lidar_type: &quot;multiple&quot;
          fix_target_lidars: true
          fix_z: false
          iteration: 3
</code></pre>

<p>The <code>data</code> section tells the tool where to get point clouds and odometry file, and also where to save the results. Note that, the keywords in <code>lidar</code> node will be recognized as frame id for the LiDARs. </p>
<p>The <code>calibration</code> section provides initial guess of the extrinsics. <strong><em>All extrinsics are from LiDAR to GNSS</em></strong>, which means this transformation maps the coordinates of a point defined in the LiDAR coordinate system to the coordinates of this point defined in the GNSS coordinate system. The initial guess requires the rotation angle error less than 5 degrees, and the translation error less than 0.1 meter.</p>
<p>The <code>steps</code> section specifies the calibration procedure. Each step is defined as follow and their meanings are in comments.</p>
<pre><code class="bash">- source_lidars: [&quot;velodyne16&quot;] # Source LiDAR in point cloud registration.
  target_lidars: [&quot;velodyne64&quot;] # Target LiDAR in point cloud registration.
  lidar_type: &quot;multiple&quot; # &quot;multiple&quot; for multi-beam LiDAR, otherwise &quot;single&quot;
  fix_target_lidars: true # Whether to fix  extrinsics of target LiDARS. Only &quot;true&quot; when align different LiDARs.
  fix_z: false # Whether to fix the z component of translation. Only &quot;false&quot; when align different LiDARs.
  iteration: 3 # Iteration number
</code></pre>

<h2 id="results-and-validation">Results and Validation</h2>
<p>The calibration tool saves the results to <code>result</code> path as follow.</p>
<pre><code class="bash">.
└── calib_result
    ├── velodyne16_novatel_extrinsics.yaml
    ├── velodyne16_result.pcd
    ├── velodyne16_result_rgb.pcd
    ├── velodyne64_novatel_extrinsics.yaml
    ├── velodyne64_result.pcd
    └── velodyne64_result_rgb.pcd
</code></pre>

<p>The two YAML files are extrinsics. To validate the results, use <code>pcl_viewer *_result.pcd</code> to check the registration quality. If the sensors are well calibrated, a large amount of details can be identified from the point cloud. For more details, please refer to the calibration guide in Apollo 1.5. </p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
